cache:
  enable: true
  max_expired_time: 604800
entry_points:
  eval:
    artifacts:
      input:
        input_model_uri: '{{train.output_model_uri}}'
      output:
      - output_dataset_uri
      - output_model_uri
      - output_uri
    command: 'export OUTPUT_MODEL_URI=$PF_OUTPUT_ARTIFACT_OUTPUT_MODEL_URI && export
      OUTPUT_URI=$PF_OUTPUT_ARTIFACT_OUTPUT_URI && /usr/bin/python3 -m gaea_operator.nodes.eval.std_algorithm
      --input-model-uri={{input_model_uri}} --output-uri={{output_uri}} --output-model-uri={{output_model_uri}}
      --output-dataset-uri={{output_dataset_uri}} '
    deps: train
    docker_env: iregistry.baidu-int.com/windmill-public/train/paddlepaddle:std-alg-138-2-dev104
    env:
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      DATASET_NAME: '{{dataset_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      MODEL_NAME: '{{model_name}}'
      ORG_ID: '{{org_id}}'
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      USER_ID: '{{user_id}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      advanced_parameters: '{"conf_threshold":"0.5","iou_threshold":"0.5"}'
      dataset_name: workspaces/internal/projects/yxdTestPipeline/datasets/ds-xplNB7iS/versions/1
      experiment_kind: Aim
      experiment_name: cvresnet
      flavour: c4m16gpu1
      model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet/versions/latest
      model_store_name: ''
      org_id: ''
      project_name: workspaces/internal/projects/proj-o97H2oAE
      queue: qtrain
      role: 'false'
      scene: ''
      skip: -1
      tracking_uri: aim://10.27.240.5:8329
      user_id: ''
      windmill_ak: a1a9069e2b154b2aa1a83ed12316d163
      windmill_endpoint: http://10.27.240.5:8340
      windmill_sk: eefac23d2660404e93855197ce60efb3
    type: step
  inference:
    artifacts:
      input:
        input_dataset_uri: '{{eval.output_dataset_uri}}'
        input_model_uri: '{{package.output_model_uri}}'
      output:
      - output_uri
    command: cd /root && python3 -m gaea_operator.nodes.inference.inference --input-model-uri={{input_model_uri}}
      --input-dataset-uri={{input_dataset_uri}} --output-uri={{output_uri}}
    deps: eval,package
    docker_env: iregistry.baidu-int.com/windmill-public/inference/nvidia:1.3.5
    env:
      ACCELERATOR: '{{accelerator}}'
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      DATASET_NAME: '{{dataset_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      LD_LIBRARY_PATH: /usr/local/cuda/compat/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/tritonserver/lib
      MODEL_NAME: '{{model_name}}'
      ORG_ID: '{{org_id}}'
      PATH: /opt/tritonserver/bin:/usr/local/mpi/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ucx/bin
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      USER_ID: '{{user_id}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      advanced_parameters: '{"conf_threshold":"0.5"}'
      dataset_name: workspaces/internal/projects/yxdTestPipeline/datasets/ds-xplNB7iS/versions/1
      experiment_kind: Aim
      experiment_name: cvresnet
      flavour: c4m16gpu1
      model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet-ensemble/versions/latest
      model_store_name: ''
      org_id: ''
      project_name: workspaces/internal/projects/proj-o97H2oAE
      queue: qtrain
      role: 'false'
      scene: ''
      skip: -1
      tracking_uri: aim://10.27.240.5:8329
      user_id: ''
      windmill_ak: a1a9069e2b154b2aa1a83ed12316d163
      windmill_endpoint: http://10.27.240.5:8340
      windmill_sk: eefac23d2660404e93855197ce60efb3
    type: step
  package:
    artifacts:
      input:
        input_model_uri: '{{transform.output_model_uri}}'
      output:
      - output_model_uri
      - output_uri
    command: cd /root && python3 -m gaea_operator.nodes.package.package --algorithm=CvResNet/Model
      --input-model-uri={{input_model_uri}} --output-uri={{output_uri}} --output-model-uri={{output_model_uri}}
    deps: transform
    docker_env: iregistry.baidu-int.com/windmill-public/inference/nvidia:1.3.5
    env:
      ACCELERATOR: '{{accelerator}}'
      ENSEMBLE_MODEL_DISPLAY_NAME: '{{ensemble_model_display_name}}'
      ENSEMBLE_MODEL_NAME: '{{ensemble_model_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      ORG_ID: '{{org_id}}'
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      SUB_EXTRA_MODELS: '{{sub_extra_models}}'
      TRACKING_URI: '{{tracking_uri}}'
      TRANSFORM_MODEL_NAME: '{{transform_model_name}}'
      USER_ID: '{{user_id}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      ensemble_model_display_name: cvresnet-ensemble
      ensemble_model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet-ensemble
      experiment_kind: Aim
      experiment_name: cvresnet
      flavour: c4m16gpu1
      model_store_name: ''
      org_id: ''
      project_name: workspaces/internal/projects/proj-o97H2oAE
      queue: qtrain
      role: 'false'
      scene: ''
      skip: -1
      sub_extra_models: ''
      tracking_uri: aim://10.27.240.5:8329
      transform_model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet-t4/versions/latest
      user_id: ''
      windmill_ak: a1a9069e2b154b2aa1a83ed12316d163
      windmill_endpoint: http://10.27.240.5:8340
      windmill_sk: eefac23d2660404e93855197ce60efb3
    type: step
  train:
    artifacts:
      output:
      - output_model_uri
      - output_uri
    command: cd /root && /usr/bin/python3 -m gaea_operator.config.std_algorithm.generate_std_pdc_input_config
      --advanced_parameters=$ADVANCED_PARAMETERS --dataset_name=$TRAIN_DATASET_NAME
      --output_root=$PF_WORK_DIR --output_uri=$PF_OUTPUT_ARTIFACT_OUTPUT_URI && cp
      /root/input_config.yaml /root/train_code/v2x_model_standardization/configs/
      && if [ -e /root/eval_config.yaml ]; then cp /root/eval_config.yaml  /root/train_code/v2x_model_standardization/paddle_framework/PaddleCls/tools/task_tools/;fi
      && export OUTPUT_MODEL_URI=$PF_OUTPUT_ARTIFACT_OUTPUT_MODEL_URI && export OUTPUT_URI=$PF_OUTPUT_ARTIFACT_OUTPUT_URI
      && /usr/bin/python3 -m gaea_operator.nodes.train.std_algorithm
    docker_env: iregistry.baidu-int.com/windmill-public/train/paddlepaddle:std-alg-138-2-dev104
    env:
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      BASE_TRAIN_DATASET_NAME: '{{base_train_dataset_name}}'
      BASE_VAL_DATASET_NAME: '{{base_val_dataset_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      MODEL_DISPLAY_NAME: '{{model_display_name}}'
      MODEL_NAME: '{{model_name}}'
      ORG_ID: '{{org_id}}'
      PF_EXTRA_WORK_DIR: /home/paddleflow/storage/mnt/fs-root-vistudio
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      TRAIN_DATASET_NAME: '{{train_dataset_name}}'
      USER_ID: '{{user_id}}'
      VAL_DATASET_NAME: '{{val_dataset_name}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    extra_fs:
    - mount_path: /home/paddleflow/storage/mnt/fs-root-vistudio
      name: vistudio
      read_only: false
    parameters:
      advanced_parameters: "{\"epoch\":\"1\",\"LearningRate.base_lr\":\"0.001\",\"\
        worker_num\":\"1\",\"eval_size\":\"640*640\",\"TrainReader.batch_size\":\"\
        8\"},\"networkArchitecture\":\"\u56FE\u50CF\u5206\u7C7B\u591A\u4EFB\u52A1\u6A21\
        \u578B-\u9AD8\u7CBE\u7248\"}"
      base_train_dataset_name: ''
      base_val_dataset_name: ''
      experiment_kind: Aim
      experiment_name: cvresnet
      flavour: c4m16gpu1
      model_display_name: cvresnet
      model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet
      model_store_name: ''
      org_id: ''
      project_name: workspaces/internal/projects/proj-o97H2oAE
      queue: qtrain
      role: 'false'
      scene: ''
      skip: -1
      tracking_uri: aim://10.27.240.5:8329
      train_dataset_name: workspaces/internal/projects/yxdTestPipeline/datasets/ds-xplNB7iS/versions/1
      user_id: ''
      val_dataset_name: workspaces/internal/projects/yxdTestPipeline/datasets/ds-xplNB7iS/versions/1
      windmill_ak: a1a9069e2b154b2aa1a83ed12316d163
      windmill_endpoint: http://10.27.240.5:8340
      windmill_sk: eefac23d2660404e93855197ce60efb3
    type: step
  transform:
    artifacts:
      input:
        input_model_uri: '{{train.output_model_uri}}'
      output:
      - output_model_uri
      - output_uri
    command: cd /workspace/KCVSDK-Ubuntu_x86_64 && source scripts/set_env.sh xpu2
      && cd /root && python3 -m gaea_operator.nodes.transform.transform --algorithm=CvResNet/Model
      --category=Image/ImageClassification/MultiTask --input-model-uri={{input_model_uri}}
      --output-uri={{output_uri}} --output-model-uri={{output_model_uri}}
    deps: train
    docker_env: iregistry.baidu-int.com/windmill-public/transform:1.3.5
    env:
      ACCELERATOR: '{{accelerator}}'
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      ORG_ID: '{{org_id}}'
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      TRAIN_MODEL_NAME: '{{train_model_name}}'
      TRANSFORM_MODEL_DISPLAY_NAME: '{{transform_model_display_name}}'
      TRANSFORM_MODEL_NAME: '{{transform_model_name}}'
      USER_ID: '{{user_id}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      advanced_parameters: ''
      experiment_kind: Aim
      experiment_name: cvresnet
      flavour: c4m16gpu1
      model_store_name: ''
      org_id: ''
      project_name: workspaces/internal/projects/proj-o97H2oAE
      queue: qtrain
      role: 'false'
      scene: ''
      skip: -1
      tracking_uri: aim://10.27.240.5:8329
      train_model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet/versions/latest
      transform_model_display_name: cvresnet-t4
      transform_model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet-t4
      user_id: ''
      windmill_ak: a1a9069e2b154b2aa1a83ed12316d163
      windmill_endpoint: http://10.27.240.5:8340
      windmill_sk: eefac23d2660404e93855197ce60efb3
    type: step
  transform-eval:
    artifacts:
      input:
        input_dataset_uri: '{{eval.output_dataset_uri}}'
        input_model_uri: '{{transform.output_model_uri}}'
      output:
      - output_dataset_uri
      - output_uri
    command: cd /root && python3 -m gaea_operator.nodes.transform_eval.transform_eval
      --algorithm=CvResNet/Model --input-model-uri={{input_model_uri}} --input-dataset-uri={{input_dataset_uri}}
      --output-dataset-uri={{output_dataset_uri}} --output-uri={{output_uri}}
    deps: eval,transform
    docker_env: iregistry.baidu-int.com/windmill-public/inference/nvidia:1.3.5
    env:
      ACCELERATOR: '{{accelerator}}'
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      DATASET_NAME: '{{dataset_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      LD_LIBRARY_PATH: /usr/local/cuda/compat/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/tritonserver/lib
      MODEL_NAME: '{{model_name}}'
      ORG_ID: '{{org_id}}'
      PATH: /opt/tritonserver/bin:/usr/local/mpi/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ucx/bin
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      USER_ID: '{{user_id}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      advanced_parameters: '{"conf_threshold":"0.5","iou_threshold":"0.5"}'
      dataset_name: workspaces/internal/projects/yxdTestPipeline/datasets/ds-xplNB7iS/versions/1
      experiment_kind: Aim
      experiment_name: cvresnet
      flavour: c4m16gpu1
      model_name: workspaces/internal/modelstores/ms-6TDGY7Hv/models/cvresnet-t4/versions/latest
      model_store_name: ''
      org_id: ''
      project_name: workspaces/internal/projects/proj-o97H2oAE
      queue: qtrain
      role: 'false'
      scene: ''
      skip: -1
      tracking_uri: aim://10.27.240.5:8329
      user_id: ''
      windmill_ak: a1a9069e2b154b2aa1a83ed12316d163
      windmill_endpoint: http://10.27.240.5:8340
      windmill_sk: eefac23d2660404e93855197ce60efb3
    type: step
failure_options:
  strategy: continue
name: cvresnet
parallelism: 6
