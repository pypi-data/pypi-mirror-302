"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[4566],{4566:(e,t,l)=>{l.r(t),l.d(t,{default:()=>z});var n=l(74389),r=l(31529),o=l(93345),i=l(4926),a=l(81719),s=l(95889),c=l(10541),d=l(46050),u=l(65736),p=l(88561),m=l(40570);const f=e=>{const t=(0,o.useMemo)((()=>o.Children.toArray(e.children).reduce(((t,l,n)=>{const r=Math.floor(n/e.numberOfColumns),o=t[r]??[];return t[r]=[...o,l],t}),[])),[e.children,e.numberOfColumns]);return(0,n.Y)("div",{style:e.containerStyle,css:{paddingBottom:2,paddingRight:2,width:"100%",height:"100%"},children:(0,n.Y)("div",{css:{width:"100%",height:"100%",overflow:"auto"},children:(0,n.Y)("table",{css:m.css`
            border-spacing: 20px 10px;
            border-collapse: separate !important;
            width: 100%;
          `,children:(0,n.Y)("tbody",{children:t.map(((e,t)=>(0,n.Y)("tr",{children:e.map(((e,t)=>(0,n.Y)("td",{children:e},t)))},t)))})})})})};var h=l(83889),g=l(78271),y=l(14153),C=l(60948),b=l(35358),v=l(95459);const S=e=>{const t=(0,C.DP)(),l=(0,b.F)(),r={color:t.textColor,paddingLeft:e.horizontalPadding,paddingRight:e.horizontalPadding,height:25},i={...r,border:"1px solid transparent",background:"transparent",":hover":{border:`1px solid  ${t.primaryColor}`,borderRadius:3},":focus":{outlineColor:t.primaryColor}},[a,s]=(0,o.useState)(e.title);return(0,o.useEffect)((()=>{s(e.title)}),[e.title]),l?(0,n.Y)("div",{css:r,children:a}):(0,n.Y)(v.AutoSizedInput,{isStrictlySized:!1,inputCss:i,value:a||"",onChange:s,onBlur:()=>{e.onTitleChange?.(a)}})},x=({differenceCell:e,referenceValue:t,measureStyle:l,isDifferenceInPercentage:n})=>{const r=Number(e?.value);return isNaN(r)||n&&isNaN(t)?"N/A":`${r>0?"+":""}${n?(0,g.m)({value:r/Math.abs(t),valueFormattedByAtotiServer:"N/A",numericFieldStyle:{numberFormat:"percentage",numberOfDecimals:2}}):(0,g.m)({value:r,valueFormattedByAtotiServer:e?.formattedValue??"N/A",numericFieldStyle:l})}`},w=({difference:e,referenceValue:t,theme:l,isDifferenceInPercentage:n})=>isNaN(e)||0===e||n&&isNaN(t)?l.textColor:e>0?l.successColor:l.errorColor,I=e=>{const t=(0,C.DP)(),{formatMessage:l}=(0,s.useIntl)(),{onTitleChange:a,title:c,isTime:d,tuple:u,onSelect:p,isSelected:m,differenceCell:f,style:b}=e,v=Number(e.referenceCell?.value),I=m?`${t.selectionOverlayColor}`:"none",M=(0,o.useMemo)((()=>{const e=u.find(h.t)?.namePath[0];return e?b?.measures?.[e]:void 0}),[u,b?.measures]),T=e.comparedCell&&(0,r.isNumber)(e.comparedCell.value)&&e.comparedCell.value<0,[[Y,N],[D,O]]=(0,o.useMemo)((()=>[e.referenceCell,e.comparedCell].map((e=>[(0,g.m)({value:Number(e?.value??0),valueFormattedByAtotiServer:e?.formattedValue??"N/A",numericFieldStyle:M}),(0,y.T)({fieldStyle:M,value:e?.value})]))),[M,e.referenceCell,e.comparedCell]);return(0,n.FD)("div",{style:{background:I,height:83,display:"flex",alignItems:"flex-end",padding:"0px 2px"},onMouseDown:e=>{(0===e.button||!m&&2===e.button)&&p({cell:f,tuple:u,isSelected:m})},children:[(0,n.Y)("span",{style:{borderLeft:`3px solid ${t.primaryColor}`,height:75}}),(0,n.FD)("div",{style:{display:"flex",paddingLeft:5,flexDirection:"column"},children:[(0,n.Y)(S,{title:c,onTitleChange:e=>{const t=(0,i.getTupleKey)(u);a?.({tupleKey:t,title:e})},horizontalPadding:"2px"}),(0,n.FD)("div",{style:{display:"flex"},children:[(0,n.FD)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"space-between",whiteSpace:"nowrap",paddingLeft:2},children:[(0,n.Y)("span",{style:{fontWeight:600,fontSize:20,lineHeight:1.5,color:O.backgroundColor||(T?t.errorColor:void 0)},children:D}),d?l({id:"aui.plugins.widget.kpi.on"},{value:e.comparedMemberCaption}):e.comparedMemberCaption]}),(0,n.Y)("span",{style:{margin:"8px 10px 3px",borderLeft:`1px solid ${t.grayScale[4]}`}}),(0,n.FD)("div",{style:{paddingTop:3,display:"flex",justifyContent:"space-around",flexDirection:"column",whiteSpace:"nowrap"},children:[(0,n.Y)("span",{style:{color:w({difference:Number(e.differenceCell?.value),referenceValue:v,theme:t,isDifferenceInPercentage:b?.isDifferenceInPercentage}),fontWeight:500},children:x({differenceCell:e.differenceCell,measureStyle:M,referenceValue:v,isDifferenceInPercentage:b?.isDifferenceInPercentage})}),(0,n.Y)("span",{style:{fontSize:9,color:N.backgroundColor},children:l({id:"aui.plugins.widget.kpi.vs"},{value:Y})}),d?l({id:"aui.plugins.widget.kpi.on"},{value:e.referenceMemberCaption}):e.referenceMemberCaption]})]})]})]})},M=(e,t)=>{const l=[];return e&&t&&l.push({tuple:t,value:e.value}),{axes:[],cells:l}};var T=l(13108);function Y(e,t){const{cells:l,numberOfColumns:n,numberOfRows:r}=(0,o.useMemo)((()=>{let t,l;for(let n=0;n<e.axes.length;n++){const r=e.axes[n];if(r.id===p.axisIds.columns?l=r:r.id===p.axisIds.rows&&(t=r),void 0!==t&&void 0!==l)break}const n=l?(0,i.getAxisLength)(l):1,r=t?(0,i.getAxisLength)(t):1,o=new Array(n*r).fill(null);return e.cells.forEach((e=>{o[e.ordinal]=e})),{numberOfColumns:n,numberOfRows:r,cells:o}}),[e]),a=(0,o.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e,{axisNames:["ROWS","COLUMNS"]})),[e]);return{cells:l,numberOfColumns:n,numberOfRows:r,cube:(0,o.useMemo)((()=>{const l=e.cube;return(0,T.W)(t,l)}),[e,t]),hierarchyIndicesInCellSet:a}}const N=["referenceCell","comparedCell","differenceCell"],D=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cube:l,hierarchyIndicesInCellSet:a,numberOfColumns:m,numberOfRows:h}=Y(e.data,e.dataModel),g=e.data.axes.find((({id:e})=>e===p.axisIds.pages));if(!g)throw new Error("A comparison was defined in the KPI widget state, but no corresponding data was found (no PAGES axis in the cellset).");const y=g.positions.length,C=(0,c.D)(g.hierarchies[0].dimension,l),b=t({id:"aui.total"}),[v,S]=(0,o.useMemo)((()=>{const{dimension:t,hierarchy:n}=g.hierarchies[0],r=g.positions.map((([r])=>(0,d.t)({captionForTotals:b,cube:l,mapping:e.mapping,member:{dimensionName:t,hierarchyName:n,...r},style:e.style})));return 3===y?r:["N/A",r[0]]}),[b,l,y,g,e.mapping,e.style]),x=(0,o.useMemo)((()=>{const t={},n=m*h;return e.data.cells.forEach((r=>{const o=Math.floor(r.ordinal%n/m),s=r.ordinal%m,c=(0,i.getTuple)({columnIndex:s,rowIndex:o,hierarchyIndicesInCellSet:a,data:e.data});if(c){const o=(0,i.getTupleKey)(c),a=t[o]?.title||e.titles?.[o]||(0,u.V)({captionForTotals:b,cube:l,mapping:e.mapping,tuple:c,style:e.style}),s=Math.floor(r.ordinal/n),d=3===y?N[s]:s===y-1?"differenceCell":"comparedCell";t[o]={...t[o],[d]:r,title:a,tuple:c}}}),{}),t}),[b,l,a,m,h,y,e.data,e.titles,e.mapping,e.style]),{titles:w,onTitlesChange:T,onSelectionChange:D}=e,O=({tupleKey:e,title:t})=>{T?.({...w,[e]:t})},[F,k]=(0,o.useState)({axes:[],cells:[]}),A=F.cells?.[0]?(0,i.getTupleKey)(F.cells[0].tuple):void 0,P=({cell:e,tuple:t,isSelected:l})=>{k(l?{axes:[],cells:[]}:M(e,t))};(0,o.useEffect)((()=>{D?.(F)}),[F,D]);const E=(0,r.map)(x,(({referenceCell:t,comparedCell:l,differenceCell:r,title:o,tuple:i},a)=>(0,n.Y)(I,{comparedCell:l,comparedMemberCaption:S,isTime:"TIME"===C.type,differenceCell:r,title:o,onTitleChange:O,referenceCell:t,referenceMemberCaption:v,tuple:i,onSelect:P,isSelected:A===a,style:e.style},a)));return(0,n.Y)(f,{numberOfColumns:m,containerStyle:e.containerStyle,children:E})};var O=l(9368),F=l(97461);const k=e=>{const t=(0,C.DP)(),{cell:l,tuple:r,tupleKey:i,onTitleChange:a,title:s,isSelected:c,onSelect:d,style:u}=e,p=(0,O.n)(l?.properties),f=c&&p.backgroundColor?(0,F.O)(p.backgroundColor,t.selectionOverlayColor,.2):c?t.selectionOverlayColor:p.backgroundColor??"none",[b,v]=(0,o.useMemo)((()=>{const e=r.find(h.t)?.namePath[0],t=e?u?.measures?.[e]:void 0;return[(0,g.m)({value:Number(l?.value),valueFormattedByAtotiServer:l?.formattedValue??"N/A",numericFieldStyle:t}),(0,y.T)({fieldStyle:t,value:l?.value})]}),[r,u?.measures,l]);return(0,n.FD)("div",{css:m.css`
        padding-left: 6px;
        border-left: 3px solid ${t.primaryColor};
        white-space: nowrap;
      `,children:[(0,n.Y)(S,{title:s,onTitleChange:e=>{a({title:e,tupleKey:i})},horizontalPadding:2}),(0,n.Y)("div",{onMouseDown:e=>{(0===e.button||!c&&2===e.button)&&d({cell:l,tuple:r,isSelected:c})},css:{background:f,color:v.backgroundColor??p.color,fontSize:30,height:50,display:"flex",alignItems:"center",paddingLeft:2},children:b})]})},A=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cells:l,numberOfColumns:r,cube:a}=Y(e.data,e.dataModel),c=(0,o.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e.data)),[e.data]),{titles:d,onTitlesChange:p,onSelectionChange:m}=e,h=({tupleKey:e,title:t})=>{p?.({...d,[e]:t})},[g,y]=(0,o.useState)({axes:[],cells:[]}),C=g.cells?.[0]?(0,i.getTupleKey)(g.cells[0].tuple):void 0,b=({cell:e,tuple:t,isSelected:l})=>{y(l?{axes:[],cells:[]}:M(e,t))},v=t({id:"aui.total"}),S=(0,o.useMemo)((()=>{const t=[];return l.forEach(((l,n)=>{const o=Math.floor(n/r),s=n%r,p=(0,i.getTuple)({columnIndex:s,data:e.data,rowIndex:o,hierarchyIndicesInCellSet:c});if(p){const n=(0,i.getTupleKey)(p),r=a?(0,u.V)({captionForTotals:v,cube:a,mapping:e.mapping,tuple:p,style:e.style}):"",o=d?.[n]||r;t.push({cell:l,tuple:p,tupleKey:n,title:o})}})),t}),[l,a,e.data,c,r,d,v,e.mapping,e.style]);(0,o.useEffect)((()=>{m?.(g)}),[g,m]);const x=S.map((({cell:t,tuple:l,tupleKey:r,title:o},i)=>(0,n.Y)(k,{cell:t,cellIndex:i,tuple:l,tupleKey:r,title:o,onTitleChange:h,onSelect:b,isSelected:C===r,style:e.style},i)));return(0,n.Y)(f,{numberOfColumns:r,containerStyle:e.containerStyle,children:x})};var P=l(60962);const E=e=>{const{comparison:t,...l}=e;return(0,P.n)(e.comparison)?(0,n.Y)(D,{comparison:t,...l}):(0,n.Y)(A,{...l})};var K=l(88409),L=l(8964);const R=(0,o.memo)((e=>{(0,v.useCallOnLoadedAfterFirstProperRender)(e);const{queryResult:t,widgetState:l,onChange:s,onSelectionChange:c}=e,d=t.data,{serverKey:u}=(0,K.useCube)(l),p=(0,a.H)(u),m=l.titles,f=(0,o.useCallback)((e=>s((0,r.isEmpty)(e)?(0,r.omit)(l,"titles"):{...l,titles:e})),[l,s]);if(!t.isLoading&&t.error){if((0,i.isErrorInQueryResultOfType)(t.error,"QueryTimeoutException"))throw new i.QueryTimeoutError(t.error);throw new i.QueryError(t.error)}return!p||(0,K.isMappingEmpty)(l.mapping)?(0,n.Y)(L.Q,{style:e.style}):d&&0!==d.cells.length?(0,n.Y)(E,{data:d,dataModel:p,titles:m,onTitlesChange:f,comparison:l.comparison,containerStyle:e.style,onSelectionChange:c,style:l.style,mapping:l.mapping}):(0,n.Y)(L.Q,{style:e.style,reason:"noData",widgetState:l,onStateChange:s})})),z=(0,K.withLoadingOverlay)((0,K.withoutIrrelevantRenders)(R))}}]);