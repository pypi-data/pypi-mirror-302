<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Run Job</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			text-align: center;
			margin: 20px;
		}

		.container {
			display: inline-block;
			text-align: left;
		}

		.dropdown {
			margin-bottom: 20px;
			position: relative;
			display: block;
		}

		.dropdown select {
			padding: 15px;
			width: 600px;
			height: 50px;
			border: 1px solid #ccc;
			border-radius: 4px;
			appearance: none;
			background: #fff;
			cursor: pointer;
			font-size: 16px;
		}

		.dropdown::after {
			content: '\25BC';
			/* Unicode character for down arrow */
			position: absolute;
			right: 20px;
			top: 50%;
			transform: translateY(-50%);
			pointer-events: none;
		}

		.buttons {
			display: flex;
			justify-content: center;
			margin-bottom: 20px;
		}

		.buttons button {
			padding: 10px 20px;
			margin: 5px;
			border: none;
			cursor: pointer;
			font-size: 16px;
			border-radius: 4px;
		}

		.submit-button {
			display: inline-block;
			padding: 10px 20px;
			background-color: #007bff;
			color: white;
			text-decoration: none;
			border-radius: 4px;
			cursor: pointer;
			border: none;
		}

		.submit-button:hover {
			background-color: #0056b3;
		}

		.submit-button:active {
			background-color: #003b80;
		}

		.submit-button:disabled {
			background-color: #cccccc;
			color: #888888;
			cursor: not-allowed;
		}

		.back-button {
			background-color: #6c757d;
			color: white;
		}

		.dropdown-label {
			margin-bottom: 5px;
			display: block;
			font-weight: bold;
		}

		.error-message {
			color: red;
			margin-top: 10px;
		}

		.loader-container {
			display: none;
		}
	</style>
</head>

<body>
	<h1>Run Job</h1>

	<p id="dataProductId">pending</p>
	<p>Click the <b>Go</b> button below to run the selected job</p>
	<div class="container">
		<!-- Job Dropdown -->
		<form id="submitForm" enctype="multipart/form-data"> 
		<div>
			<input id="data_product_id"/>
		</div>
		<div class="dropdown">
			<label class="dropdown-label" for="job_name">Select job to run</label>
			<select id="job_name" name="job_name" onchange="showSelection()">
				<option>Please select</option>
				{% for job in jobs %}
				<option value="{{ job }}">{{ job }}</option>
				{% endfor %}
			</select>
		</div>

		<!-- Environment Dropdown -->
		<div class="dropdown">
			<label class="dropdown-label" for="environment">Select environment</label>
			<select id="environment" name="environment" onchange="showSelection()">
				<option>Please select</option>
				{% for env in environments %}
				<option value="{{ env }}">{{ env }}</option>
				{% endfor %}
			</select>
		</div>

		<div class="buttons">
			<button class="submit-button" type="submit">Go</button>
			<button class="back-button" onclick="goBack()">Back</button>
		</div>
		</form>
		<div id="feedbackContainer">
			<div class="error-message" id="errorMessage"></div>
		</div>

		<div class="loader-container" id="loaderContainer">
			<div class="loader" id="spinner"></div>
		</div>
		<p id="userId">User ID: pending</p>
		<script>
			function showSelection() {
				const selectJob = document.getElementById('job_name');
				const selectedJob = selectJob.options[selectJob.selectedIndex].value;

				const selectEnv = document.getElementById('environment');
				const selectedEnv = selectEnv.options[selectEnv.selectedIndex].value;

			}
		</script>
</body>

<script>
	window.onload = function () {
		// Get the user ID from the cookie or fallback to a default value
		var userId = getCookie("user_id");
		if (!userId) {
			userId = "test@cdc.gov";
			setCookie("user_id", userId)
		}

		// Try to read the data_product_id from the URL parameter by name
		var dataProductId = getParameterByName("data_product_id");

		// If data_product_id is not found, attempt to get it from the last part of the URL
		if (!dataProductId) {
			dataProductId = getLastPartOfURL();
			console.log("Data Product ID from last part of URL: " + dataProductId);
		}

		// If data_product_id was found, save it in a cookie for future use
		if (dataProductId) {
			setCookie("data_product_id", dataProductId, 7); // Store for 7 days
		} else {
			// Try to get it from the cookie if not in the URL
			dataProductId = getCookie("data_product_id");
			console.log("Data Product ID from cookie: " + dataProductId);
		}

		document.getElementById("submitForm").addEventListener("submit", performRunJob);

		// Update the UI to show the retrieved IDs
		document.getElementById("userId").textContent = "User ID: " + userId;
		document.getElementById("dataProductId").textContent = "Data Product ID: " + dataProductId;
		document.getElementById("data_product_id").value = dataProductId;
	};

	// Function to go back in browser history
	function goBack() {
		window.history.back();
	}

	// Function to get a cookie value by name
	function getCookie(name) {
		const value = "; " + document.cookie;
		const parts = value.split("; " + name + "=");
		if (parts.length == 2) {
			return parts.pop().split(";").shift();
		} else {
			return undefined;
		}
	}

	// Function to get a URL parameter by name
	function getParameterByName(name, url = window.location.href) {
		name = name.replace(/[\[\]]/g, "\\$&");
		const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	// Function to get the last part of the URL (after the last `/`)
	function getLastPartOfURL(url = window.location.href) {
		const urlParts = url.split('/');
		const lastPart = urlParts[urlParts.length - 1];
		return lastPart ? decodeURIComponent(lastPart) : null;
	}

	// Function to set a cookie
	function setCookie(name, value, days) {
		const d = new Date();
		d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
		const expires = "expires=" + d.toUTCString();
		document.cookie = name + "=" + value + ";" + expires + ";path=/";
	}

	// Function to handle form submission with validation
	function performRunJob(event) {
		event.preventDefault();
		var data = new FormData();
		data.append("user_id", getCookie("user_id"));
		data.append("data_product_id", getCookie("data_product_id"));
		// Get selected values from dropdowns
		var selectedJob = document.getElementById('job_name').value;
		var selectedEnv = document.getElementById('environment').value;
		data.append("job_name", selectedJob);
		data.append("environment", selectedEnv);
		var submitButton = document.querySelector(".submit-button");
		var spinner = document.getElementById("spinner");
		var feedbackContainer = document.getElementById("feedbackContainer");
		var errorMessage = document.getElementById("errorMessage");

	

		// Validation: Ensure both dropdowns have valid selections
		if (selectedJob === "Please select" || selectedEnv === "Please select") {
			errorMessage.textContent = "Both Job and Environment must be selected!";
			errorMessage.style.display = "block";
 
			return; // Prevent submission
		}

		// Hide error message
		errorMessage.style.display = "none";

		// Disable the button and show the spinner
		submitButton.disabled = true;
		spinner.style.display = "inline-block";

		var job_url = `../../cdh_lava/job_run`;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", job_url, true);
 
		xhr.onload = function () {
        // Re-enable the button and hide the spinner
        submitButton.disabled = false;
        spinner.style.display = "none";

        // Check for HTTP status codes
        if (xhr.status >= 200 && xhr.status < 400) {
            var contentType = xhr.getResponseHeader("Content-Type");

            if (contentType && contentType.includes("application/json")) {
                try {
                    var resp = JSON.parse(xhr.responseText);

                    // Check if "data" equals "Success"
                    if (resp.data === "Success") {
                        feedbackContainer.innerHTML = `Success: Upload completed. Trace ID: <a href="../../files/dashboards/dependency_graph/${resp.trace_id}" target="_self">${resp.trace_id}</a>`;
                        feedbackContainer.style.color = "green"; // Optional: make the feedback green
                        console.log(resp);

                        // Optionally, handle additional fields from the response
                        console.log("Trace ID:", resp.trace_id);
                        console.log("Total Time:", resp.total_time);
                        console.log("File Path:", resp.file_path);
                    } else {
                        // If "data" is not "Success", display an error message
                        feedbackContainer.textContent = "Error: Upload failed. Trace ID: " + resp.trace_id.toString();
                        feedbackContainer.style.color = "red";
                        console.error("Upload failed:", resp);
                    }
                } catch (error) {
                    feedbackContainer.textContent = "Error parsing server response.";
                    feedbackContainer.style.color = "red";
                    console.error("Parsing error:", error);
                }
            } else {
                feedbackContainer.textContent = "Unexpected response format. Please contact support.";
                feedbackContainer.style.color = "red";
                console.error("Unexpected response:", xhr.responseText);
                alert("Unexpected response format received.");
            }
        } else {
            feedbackContainer.textContent = `Error: Server responded with status ${xhr.status}`;
            feedbackContainer.style.color = "red";
            console.error("Server error:", xhr.responseText);
            alert("Error uploading file: " + xhr.responseText);
        }
    };

    // Handle connection errors
    xhr.onerror = function () {
        // Ensure feedbackContainer is available
        feedbackContainer = feedbackContainer || document.getElementById("feedbackContainer");

        var contentType = xhr.getResponseHeader("Content-Type");

        if (contentType && contentType.includes("application/json")) {
            try {
                var resp = JSON.parse(xhr.responseText);
                feedbackContainer.textContent = "Error: An error occurred during the upload. " + resp.data;
            } catch (error) {
                feedbackContainer.textContent = "Error parsing server response.";
                console.error("Parsing error:", error);
            }
        } else {
            feedbackContainer.textContent = "Error: Network or server issue occurred.";
        }
        
        feedbackContainer.style.color = "red"; // Optional: make the feedback red
        submitButton.disabled = false;
        spinner.style.display = "none";
        console.error("Connection error");
        alert("Error uploading file");
    };

    // Send the form data
    xhr.send(data);
	}

</script>

</html>